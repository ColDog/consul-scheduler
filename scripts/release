#!/usr/bin/env bash

version=v${1}
message="Release of version "${1}

echo releasing ${version} with ${message}

set -e

if [ ${version} = "" ]; then
    echo "version must be given"
    exit 1
fi

if git tag -l | grep -Fxq ${version}; then
    echo "version already exists"
    exit 1
fi

# handle git stuff
git add -A && git commit -m "${message}"
git tag ${version} -m "${message}"
git push origin --all
git push origin --tags

body=$(curl --data '{"tag_name": "'${version}'","target_commitish": "master","name": "'${version}'","body": "'${message}'"}' https://api.github.com/repos/coldog/consul-scheduler/releases?access_token=${GITHUB_TOKEN})

echo ${body}

# create compilations
#echo "beginning compilations"
#env GOOS=linux GOARCH=amd64     go build -o dist/consul-scheduler_linux-amd64 github.com/coldog/scheduler
#env GOOS=linux GOARCH=arm       go build -o dist/consul-scheduler_linux-arm github.com/coldog/scheduler
#env GOOS=darwin GOARCH=amd64    go build -o dist/consul-scheduler_darwin-amd64 github.com/coldog/scheduler
#env GOOS=windows GOARCH=386     go build -o dist/consul-scheduler_windows-386 github.com/coldog/scheduler
#env GOOS=windows GOARCH=amd64   go build -o dist/consul-scheduler_windows-amd64 github.com/coldog/scheduler


#docker build -t coldog/consul-scheduler:${version} .
#docker tag coldog/consul-scheduler:${version} coldog/consul-scheduler:latest
#docker push coldog/consul-scheduler:${version}
